<!DOCTYPE html>
<html lang="ru">
<head>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WalletStars | Купить Звёзды</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* Ваши стили остаются без изменений */
    body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: #181A1B; color: #fff; min-height: 100vh; padding-bottom: 70px; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 18px 16px 10px 16px; background: #181A1B; z-index: 10; position: sticky; top: 0; }
    .header-title { font-size: 18px; font-weight: 500; }
    .header-actions { display: flex; gap: 10px; }
    .tab-content { display: none; width: 100%; animation: fadein .2s; }
    .tab-content.active { display: block; }
    @keyframes fadein { from { opacity: 0; } to { opacity: 1; } }
    /* Маркет */
    .section-title { text-align: center; font-size: 22px; font-weight: 700; margin-top: 18px; margin-bottom: 6px; }
    .section-subtitle { text-align: center; font-size: 15px; color: #bdbdbd; margin-bottom: 18px; }
    .cards-container { display: flex; gap: 18px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
    .card { background: #232629; border-radius: 12px; width: 165px; max-width: 95vw; text-align: center; padding: 18px 8px 16px 8px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
    .card img { width: 75px; height: 75px; margin-bottom: 12px; border-radius: 12px; object-fit: contain; background: #16191a; }
    .card h3 { font-size: 18px; font-weight: 600; margin-bottom: 7px; color: #fff; }
    .btn { margin-top: 7px; background: #1687fa; color: #fff; border: none; border-radius: 8px; padding: 9px 0; width: 94px; font-size: 16px; font-weight: 500; cursor: pointer; transition: background .2s; }
    .btn:hover { background: #0f6bcc; }
    .primary-btn { background: #1687fa; }
    .secondary-btn { background: #5BB318; }
    /* Партнерство */
    .referral-card { display: flex; gap: 10px; margin: 22px 10px 16px 10px; flex-direction: column; }
    .referral-percent { flex: 1; display: flex; align-items: center; justify-content: center; background: #1687fa; border-radius: 14px; font-size: 2rem; font-weight: 700; color: #fff; padding: 20px 0; }
    .referral-link { display: flex; align-items: center; gap: 7px; background: #232629; border-radius: 8px; margin: 0 10px 8px 10px; padding: 10px; }
    #ref-link-input { flex: 1; color: #fff; font-size: 14px; word-break: break-all; background: transparent; border: none; outline: none; }
    .referral-stats { display: flex; gap: 10px; margin: 14px 10px 10px 10px; }
    .stat-item { background: #232629; border-radius: 10px; flex: 1; text-align: center; padding: 13px 0 7px 0; }
    .stat-item span { font-size: 19px; font-weight: 700; color: #fff; }
    .stat-item p { font-size: 13px; color: #bbb; margin: 5px 0; }
    /* Tabs */
    .bottom-nav { position: fixed; left: 0; right: 0; bottom: 0; background: #222426; display: flex; justify-content: space-around; padding: 6px 0 2px 0; border-top: 1px solid #232629; z-index: 12; }
    .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; font-size: 12px; color: #888; border: none; background: none; padding: 5px 0 2px 0; cursor: pointer; transition: color .2s; }
    .nav-btn.active { color: #1687fa; }
    .nav-btn .material-icons { font-size: 22px; margin-bottom: 2px; }
    /* Modal styles */
    .modal { display: none; position: fixed; left: 0; top: 0; right: 0; bottom: 0; background: rgba(24,26,27,0.75); z-index: 100; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: #232629; border-radius: 16px; padding: 28px 18px 22px 18px; max-width: 92vw; width: 340px; box-sizing: border-box; position: relative; box-shadow: 0 6px 40px 0 rgba(0,0,0,0.45); color: #fff; animation: fadein .18s; }
    .close-btn { position: absolute; right: 13px; top: 13px; color: #888; background: none; border: none; font-size: 25px; cursor: pointer; z-index: 110; }
    .modal-content h2 { font-size: 21px; font-weight: 700; margin-bottom: 10px; text-align: center; }
    .modal-desc { font-size: 14px; color: #aaa; margin-bottom: 20px; text-align: center; }
    .form-group { margin-bottom: 15px; }
    .form-group label { font-size: 15px; margin-bottom: 7px; display: block; }
    .form-group input { width: 100%; border-radius: 7px; border: 1px solid #323537; background: #181A1B; color: #fff; font-size: 17px; padding: 13px 12px; box-sizing: border-box; margin-bottom: 2px; outline: none; transition: border .2s; }
    .form-group input:focus { border: 1.5px solid #1687fa; }
    .price-display { font-size: 17px; padding: 13px 12px; background: #181A1B; border-radius: 7px; }
    .full-width { width: 100%; }
    .wallet-section { text-align: center; margin-top: 20px; padding: 10px; background: #232629; border-radius: 10px; }
    .wallet-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .wallet-btn { background: #1687fa; color: white; border: none; border-radius: 8px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
    .notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 20px; border-radius: 5px; background: #333; color: white; z-index: 1000; display: none; }
    .notification.show { display: block; }
    .notification.error { background: #d32f2f; }
    .notification.success { background: #388e3c; }
    .notification.info { background: #1976d2; }
    .widget-image-container { text-align: center; margin-bottom: 20px; }
    .widget-image-container img { max-width: 100px; height: auto; border-radius: 10px; }
    @media (max-width: 480px) {
      .header { font-size: 14px; }
      .card { width: 96vw; min-width: 140px; }
      .referral-percent { width: 100%; }
      .modal-content { width: 97vw; padding: 22px 7vw 18px 7vw;}
    }
  </style>
</head>
<body>
  <!-- Шапка приложения -->
  <header class="header">
    <div class="header-title">WalletStars | Купить Звёзды</div>
    <div class="wallet-info">
      <span id="wallet-status">Кошелёк не подключен</span>
      <button id="connect-wallet-btn" class="wallet-btn">
        <span class="material-icons">account_balance_wallet</span> Подключить
      </button>
    </div>
  </header>

  <!-- Основной контент -->
  <main class="content">
    <!-- Вкладка Маркет -->
    <section class="tab-content active" id="market">
      <h2 class="section-title">Маркет WalletStars</h2>
      <p class="section-subtitle">Покупайте звёзды. Дарите Premium своим друзьям</p>

      <div class="cards-container">
        <!-- Карточка TON -->
        <div class="card">
          <div class="card-icon ton-bg">
            <img id="ton-card-image" src="buy.png" alt="Купить за TON" class="widget-image">
          </div>
          <h3>Купить звёзды (TON)</h3>
          <p>1 звезда = 0.1 TON</p>
          <button id="buy-ton-btn" class="btn primary-btn">Купить</button>
        </div>

        <!-- Карточка RUB -->
        <div class="card">
          <div class="card-icon rub-bg">
            <img id="rub-card-image" src="rub.png" alt="Купить за рубли" class="widget-image">
          </div>
          <h3>Купить звёзды (RUB)</h3>
          <p>1 звезда = 10 RUB</p>
          <button id="buy-rub-btn" class="btn primary-btn">Купить</button>
        </div>
      </div>

      <!-- Кошелек ТОЛЬКО в Маркете -->
      <div class="wallet-section">
        <p>Подключите кошелёк для покупки звёзд за TON</p>
        <div id="wallet-buttons"></div>
      </div>
    </section>

    <!-- Вкладка Партнерство -->
    <section class="tab-content" id="partnership">
      <h2 class="section-title">Партнёрская программа</h2>

      <div class="referral-card">
        <div class="referral-percent">
          <span>50%</span>
          <p>Ваш процент</p>
        </div>

        <div class="referral-stats">
          <div class="stat-item">
            <span id="referrals-count">0</span>
            <p>Приглашено</p>
          </div>
          <div class="stat-item">
            <span id="earned-amount">0 TON</span>
            <p>Заработано</p>
          </div>
        </div>

        <div class="referral-link">
          <input type="text" id="ref-link-input" readonly value="Загрузка...">
          <button id="copy-ref-btn" class="btn secondary-btn">
            <span class="material-icons">content_copy</span>
          </button>
        </div>

        <button id="share-ref-btn" class="btn primary-btn">
          <span class="material-icons">share</span> Поделиться
        </button>
      </div>
    </section>
  </main>

  <!-- Нижняя навигация -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-tab="market">
      <span class="material-icons">store</span>
      Маркет
    </button>
    <button class="nav-btn" data-tab="partnership">
      <span class="material-icons">people</span>
      Партнёрство
    </button>
  </nav>

  <!-- Модальные окна -->
  <div class="modal" id="ton-modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Покупка звёзд за TON</h2>

      <div class="widget-image-container">
        <img id="ton-widget-image" src="buy.png" alt="Купить за TON">
      </div>

      <div class="form-group">
        <label>Количество звёзд (мин. 10):</label>
        <input type="number" id="ton-stars" min="10" value="10">
      </div>

      <div class="form-group">
        <label>Стоимость:</label>
        <div class="price-display">
          <span id="ton-price">1.0</span> TON
        </div>
      </div>

      <button id="confirm-ton-btn" class="btn primary-btn full-width">
        <span class="material-icons">shopping_cart</span> Купить
      </button>
    </div>
  </div>

  <div class="modal" id="rub-modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Покупка звёзд за RUB</h2>

      <div class="widget-image-container">
        <img id="rub-widget-image" src="rub.png" alt="Купить за рубли">
      </div>

      <div class="form-group">
        <label>Количество звёзд (мин. 1):</label>
        <input type="number" id="rub-stars" min="1" value="1">
      </div>

      <div class="form-group">
        <label>Стоимость:</label>
        <div class="price-display">
          <span id="rub-price">10</span> RUB
        </div>
      </div>

      <button id="confirm-rub-btn" class="btn primary-btn full-width">
        <span class="material-icons">payment</span> Оплатить
      </button>
    </div>
  </div>

  <!-- Уведомления -->
  <div id="notification" class="notification"></div>

  <!-- Скрипты -->
  <script src="https://cdn.jsdelivr.net/npm/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
  <script src="https://cdn.yookassa.ru/checkout-widget/v1/checkout-widget.js"></script>
  <script>
    // Конфигурация
const CONFIG = {
    TON_PRICE: 0.1,
    RUB_PRICE: 10,
    BACKEND_URL: 'https://ваш-сервер.com/api',
    MANIFEST_URL: 'https://ваш-сайт.com/tonconnect-manifest.json',
    YOOMONEY_ID: 'ВАШ_MERCHANT_ID',
    IMAGE_PATHS: {
        TON: 'buy.png',
        RUB: 'rub.png'
    }
};
// Проверяем, открыто ли приложение в Telegram
const tg = window.Telegram?.WebApp;

if (tg) {
    tg.expand(); // Развернуть WebApp на весь экран
    tg.enableClosingConfirmation(); // Запросить подтверждение при закрытии

    // Цветовая схема (подстраивается под тему Telegram)
    document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#181A1B');
    document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
    document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#1687fa');
}

// Элементы DOM
let elements = {};
let connector;
let wallet;

// Инициализация приложения
async function initApp() {
    // Сбор элементов DOM
    collectDOMElements();

    // Инициализация TON Connect
    await initTonConnect();

    // Настройка обработчиков событий
    setupEventListeners();

    // Инициализация ЮMoney
    initYooMoney();

    // Инициализация цен
    updatePrices();

    // Установка изображений для виджетов
    setWidgetImages();

    // Загрузка реферальных данных если активна вкладка Партнерство
    if (elements.partnershipTab.classList.contains('active')) {
        loadRefData();
    }
}

// Установка изображений для виджетов
function setWidgetImages() {
    if (elements.tonImage) {
        elements.tonImage.src = CONFIG.IMAGE_PATHS.TON;
    }
    if (elements.rubImage) {
        elements.rubImage.src = CONFIG.IMAGE_PATHS.RUB;
    }
}

// Сбор элементов DOM
function collectDOMElements() {
    elements = {
        // Кнопки
        buyTonBtn: document.getElementById('buy-ton-btn'),
        buyRubBtn: document.getElementById('buy-rub-btn'),
        connectWalletBtn: document.getElementById('connect-wallet-btn'),
        confirmTonBtn: document.getElementById('confirm-ton-btn'),
        confirmRubBtn: document.getElementById('confirm-rub-btn'),
        copyRefBtn: document.getElementById('copy-ref-btn'),
        shareRefBtn: document.getElementById('share-ref-btn'),

        // Модальные окна
        tonModal: document.getElementById('ton-modal'),
        rubModal: document.getElementById('rub-modal'),

        // Изображения виджетов
        tonImage: document.getElementById('ton-widget-image'),
        rubImage: document.getElementById('rub-widget-image'),

        // Формы
        tonStarsInput: document.getElementById('ton-stars'),
        rubStarsInput: document.getElementById('rub-stars'),
        tonPriceDisplay: document.getElementById('ton-price'),
        rubPriceDisplay: document.getElementById('rub-price'),

        // Статус кошелька
        walletStatus: document.getElementById('wallet-status'),
        walletButtons: document.getElementById('wallet-buttons'),

        // Реферальная система
        refLinkInput: document.getElementById('ref-link-input'),
        referralsCount: document.getElementById('referrals-count'),
        earnedAmount: document.getElementById('earned-amount'),

        // Уведомления
        notification: document.getElementById('notification'),

        // Навигация
        navBtns: document.querySelectorAll('.nav-btn'),
        tabContents: document.querySelectorAll('.tab-content'),

        // Вкладки
        marketTab: document.getElementById('market'),
        partnershipTab: document.getElementById('partnership')
    };
}

// Инициализация TON Connect
async function initTonConnect() {
    try {
        // Проверка доступности TonConnectSDK
        if (!window.TonConnect) {
            throw new Error('TonConnect SDK не загружен');
        }

        connector = new TonConnect.TonConnect({
            manifestUrl: CONFIG.MANIFEST_URL
        });

        // Проверка подключения
        if (connector.connected) {
            wallet = connector.account;
            updateWalletStatus();
        }

        // Подписка на изменения
        connector.onStatusChange(wallet => {
            updateWalletStatus(wallet);
        });

        // Обновление кнопок кошельков
        await updateWalletButtons();
    } catch (error) {
        showNotification('Ошибка TON Connect: ' + error.message, 'error');
    }
}

// Обновление кнопок кошельков
async function updateWalletButtons() {
    try {
        const wallets = await connector.getWallets();
        if (!elements.walletButtons) return;

        elements.walletButtons.innerHTML = '';

        wallets.forEach(wallet => {
            const button = document.createElement('button');
            button.className = 'wallet-btn';
            button.textContent = wallet.name;
            button.onclick = () => connectWallet(wallet);
            elements.walletButtons.appendChild(button);
        });
    } catch (error) {
        console.error('Ошибка получения кошельков:', error);
    }
}

// Обновление статуса кошелька
function updateWalletStatus(w = null) {
    if (w) wallet = w;

    if (wallet && elements.walletStatus) {
        elements.walletStatus.textContent = `Кошелёк: ${wallet.name}`;
        elements.connectWalletBtn.textContent = 'Отключить';
    } else if (elements.walletStatus) {
        elements.walletStatus.textContent = 'Кошелёк не подключен';
        elements.connectWalletBtn.textContent = 'Подключить';
    }
}

// Подключение кошелька
async function connectWallet(walletInfo = null) {
    try {
        if (connector.connected) {
            await connector.disconnect();
            wallet = null;
            updateWalletStatus();
            return;
        }

        if (walletInfo) {
            await connector.connect(walletInfo);
        } else {
            const wallets = await connector.getWallets();
            if (wallets.length > 0) {
                await connector.connect(wallets[0]);
            }
        }
    } catch (error) {
        showNotification('Ошибка подключения: ' + error.message, 'error');
    }
}

// Инициализация ЮMoney
function initYooMoney() {
    try {
        if (typeof YooMoneyCheckoutWidget === 'undefined') {
            throw new Error('ЮMoney виджет не загружен');
        }

        window.yooMoneyCheckoutWidget = new YooMoneyCheckoutWidget({
            merchant_id: CONFIG.YOOMONEY_ID,
            language: 'ru',
            theme: 'dark'
        });
    } catch (error) {
        console.error('Ошибка инициализации ЮMoney:', error);
        showNotification('Ошибка платежной системы', 'error');
    }
}

// Покупка за TON
async function buyWithTon() {
    const stars = parseInt(elements.tonStarsInput.value);
    const amount = stars * CONFIG.TON_PRICE;

    if (!connector || !connector.connected) {
        showNotification('Сначала подключите кошелёк', 'error');
        return;
    }

    if (stars < 10) {
        showNotification('Минимальная покупка: 10 звёзд', 'error');
        return;
    }

    try {
        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 300,
            messages: [{
                address: 'EQCbaFt3eQy4r7e3Qq1XOyW2N9l5nQvJ2Aiy8G4VZpQkL1bh',
                amount: (amount * 1000000000).toString(),
                payload: `Покупка ${stars} звёзд`
            }]
        };

        showNotification('Подтвердите транзакцию в кошельке...', 'info');
        const result = await connector.sendTransaction(transaction);
        showNotification('Транзакция отправлена!', 'success');

        // Отправка данных на бекенд
        await fetch(`${CONFIG.BACKEND_URL}/process_ton`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                tx_hash: result.boc,
                amount: amount,
                stars: stars
            })
        });

        closeModal(elements.tonModal);
    } catch (error) {
        showNotification('Ошибка: ' + error.message, 'error');
    }
}

// Покупка за RUB
function buyWithRub() {
    const stars = parseInt(elements.rubStarsInput.value);
    const amount = stars * CONFIG.RUB_PRICE;

    if (stars < 1) {
        showNotification('Минимальная покупка: 1 звезда', 'error');
        return;
    }

    try {
        if (!window.yooMoneyCheckoutWidget) {
            throw new Error('Платежный виджет не инициализирован');
        }

        window.yooMoneyCheckoutWidget.amount = amount;
        window.yooMoneyCheckoutWidget.description = `Покупка ${stars} звёзд`;
        window.yooMoneyCheckoutWidget.open();

        window.yooMoneyCheckoutWidget.on('success', () => {
            showNotification('Оплата прошла успешно!', 'success');
            closeModal(elements.rubModal);
        });
    } catch (error) {
        showNotification('Ошибка ЮMoney: ' + error.message, 'error');
    }
}

// Загрузка реферальных данных
async function loadRefData() {
    try {
        // Здесь будет запрос к вашему бекенду
        elements.refLinkInput.value = 'https://t.me/WalletStarsBot?start=ref_12345';
        elements.referralsCount.textContent = '5';
        elements.earnedAmount.textContent = '2.5 TON';
    } catch (error) {
        console.error('Ошибка загрузки реферальных данных:', error);
    }
}

// Копирование реферальной ссылки
function copyRefLink() {
    elements.refLinkInput.select();
    document.execCommand('copy');
    showNotification('Ссылка скопирована!', 'success');
}

// Поделиться ссылкой
function shareRefLink() {
    if (navigator.share) {
        navigator.share({
            title: 'Присоединяйся к WalletStars!',
            text: 'Получай бонусы за покупки звёзд',
            url: elements.refLinkInput.value
        });
    } else {
        copyRefLink();
    }
}

// Открытие модального окна
function openModal(modal) {
    modal.classList.add('active');
}

// Закрытие модального окна
function closeModal(modal) {
    modal.classList.remove('active');
}

// Показать уведомление
function showNotification(message, type = 'info') {
    if (!elements.notification) return;

    elements.notification.textContent = message;
    elements.notification.className = 'notification';
    elements.notification.classList.add(type, 'show');

    setTimeout(() => {
        elements.notification.classList.remove('show');
    }, 3000);
}

// Обновление цен
function updatePrices() {
    const tonStars = parseInt(elements.tonStarsInput.value) || 0;
    const rubStars = parseInt(elements.rubStarsInput.value) || 0;

    if (elements.tonPriceDisplay) {
        elements.tonPriceDisplay.textContent = (tonStars * CONFIG.TON_PRICE).toFixed(2);
    }

    if (elements.rubPriceDisplay) {
        elements.rubPriceDisplay.textContent = (rubStars * CONFIG.RUB_PRICE).toFixed(2);
    }
}

// Настройка обработчиков событий
function setupEventListeners() {
    // Кнопки покупки
    if (elements.buyTonBtn) {
        elements.buyTonBtn.addEventListener('click', () => openModal(elements.tonModal));
    }

    if (elements.buyRubBtn) {
        elements.buyRubBtn.addEventListener('click', () => openModal(elements.rubModal));
    }

    // Кнопки подтверждения покупки
    if (elements.confirmTonBtn) {
        elements.confirmTonBtn.addEventListener('click', buyWithTon);
    }

    if (elements.confirmRubBtn) {
        elements.confirmRubBtn.addEventListener('click', buyWithRub);
    }

    // Кнопка подключения кошелька
    if (elements.connectWalletBtn) {
        elements.connectWalletBtn.addEventListener('click', () => connectWallet());
    }

    // Реферальные кнопки
    if (elements.copyRefBtn) {
        elements.copyRefBtn.addEventListener('click', copyRefLink);
    }

    if (elements.shareRefBtn) {
        elements.shareRefBtn.addEventListener('click', shareRefLink);
    }

    // Закрытие модальных окон
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) closeModal(modal);
        });
    });

    // Навигация между вкладками
    if (elements.navBtns) {
        elements.navBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;

                // Обновление активной кнопки
                elements.navBtns.forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                // Показать активный контент
                elements.tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');

                // Загружаем реферальные данные при переходе на вкладку партнерства
                if (tabId === 'partnership') {
                    loadRefData();
                }
            });
        });
    }

    // Обновление цен при изменении количества звезд
    if (elements.tonStarsInput) {
        elements.tonStarsInput.addEventListener('input', updatePrices);
    }

    if (elements.rubStarsInput) {
        elements.rubStarsInput.addEventListener('input', updatePrices);
    }

    // Закрытие модалок при клике вне контента
    window.addEventListener('click', (event) => {
        if (elements.tonModal && event.target === elements.tonModal) {
            closeModal(elements.tonModal);
        }
        if (elements.rubModal && event.target === elements.rubModal) {
            closeModal(elements.rubModal);
        }
    });
}

// Запуск приложения
document.addEventListener('DOMContentLoaded', initApp);
    // Весь ваш JavaScript код здесь...
    // Вставьте предоставленный JavaScript код начиная с этого места
  </script>
</body>
</html>